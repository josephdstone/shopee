<!DOCTYPE html>

<html>

    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="jquery-mobile/styles/jquery.mobile-1.3.1.min.css" rel="stylesheet" />
        <link href="styles/main.css" rel="stylesheet" />

        <script src="cordova.js" type="text/javascript"></script>
        <script src="jquery-mobile/js/jquery-1.9.1.min.js" type="text/javascript"></script>
        <script src="jquery-mobile/js/jquery.mobile-1.3.1.min.js" type="text/javascript"></script>

        <script src="scripts/login.js" type="text/javascript"></script>
        <script src="scripts/location.js" type="text/javascript"></script>
        <script src="Plugins/com.phonegap.plugins.barcodescanner-0.7.0/www/barcodescanner.js"></script>
        <title>Scan Your Item</title>
    </head>

    <body>
        <H1 style="color:#B80000">Scan Your Item</H1>
        <img style="width: 110px; height: 100px" src="styles/images/cart.ico">
        <br>
        <br>
        <button class="button" id="btnScan">Scan</button>
        <a id="btnBack" data-role="button" href="modeSelect.html"
           data-icon="home" data-iconpos="right">
            Previous Page
        </a>
        <a id="btnClearTotal" data-role="button" onClick="clearShoppeeCart()" href=""
           data-icon="delete" data-iconpos="right">
            Clear Cart
        </a>
        <label>Tax Rate %</label>
            <input style="text-align:center"  id="tax" value="7" type="number" data-mini="false">
        <br>
            <label>Shoppee Cart Total</label>
            <input style="text-align:center"  id="total" value="" type="number" data-mini="false" readonly>
        <br>
        <div data-role="collapsible" data-collapsed="true" data-theme="b" class="ui-collapsible">
            <h3 class="ui-collapsible-heading"><a href="#" class="ui-collapsible-heading-toggle ui-btn ui-fullsize ui-btn-icon-left ui-corner-top ui-corner-bottom ui-btn-up-b" data-corners="false" data-shadow="false" data-iconshadow="true" data-wrapperels="span" data-icon="plus" data-iconpos="left" data-theme="b" data-mini="false">
                </a>
				Manual Options</h3>
                
				<p>
                    <label>Item Name</label>
            <input style="text-align:center"  id="manName" type="text" data-mini="false">
                    <label>Item Price</label>
            <input style="text-align:center"  id="manPrice" type="number" data-mini="false">
                    <br>
                    <a id="btnManualAdd" data-role="button" onClick="manAdd()" href="" data-icon="plus" data-iconpos="right">
                        Add Item to Cart
                    </a>
                    
                </p>
			</div>
        <br>
        <h3>Shoppee Cart</h3>
        
        
        <ul data-role="listview">
            <li id="results" data-role="listview" data-theme="b"></li>
	    </ul>
          
        
        <style>
        ul
            {
                
    			width: 100%;
    			margin-left: -40px;
			}
        </style>
        <script>
            notification.alert();
            var totalScanned = -0;
            var taxRate = -0;
            var grandTotal = -0;
            var counter = -0;
            var subtract = -0;
            function clearShoppeeCart()
            {
                totalScanned = 0;
                document.getElementById('total').value = ""; 
                $("#results").html("").add();
                totalScanned = 0;
                taxRate = 0;
                grandTotal = 0;
            	counter = 0;
            }
            
            function manAdd()
            {
                grandTotal = document.getElementById('total').value;
                var manualName = document.getElementById('manName').value;
                var val = document.getElementById('manPrice').value;
                counter += 1;
                $("#results").append("<li data-icon='minus' id="+counter+" onclick='deleteItem($(a"+counter+").text(), "+counter+");'><a style='color:white' id='a"+counter+"'>"+manualName +" $"+ val+"</a></li>");
                $('#results').listview('refresh');
                var split = $("#a1").text().split("$");
                totalScanned += parseFloat(val);
                taxRate = document.getElementById('tax').value * .01;
                grandTotal = totalScanned + (taxRate * totalScanned);
                document.getElementById('total').value =  (grandTotal).toFixed(2); 
                document.getElementById('manName').value = "";
                document.getElementById('manPrice').value = "";
                manualName = "";
                val = -0;
            }
            
            function deleteItem(value, counter)
            {
                var split = (value).split("$");
                price = split[1];
                taxrate = document.getElementById('tax').value *.01; 
                subtract = parseFloat(price * 1  + ( 1 * taxrate * price * 1)).toFixed(2);
                totalScanned -= price;
                grandTotal = parseFloat(document.getElementById('total').value);
                grandTotal -= subtract;
            	document.getElementById('total').value = (grandTotal).toFixed(2);
                $("#" + counter).remove();
            }
            
            $("#btnScan").click(function () 
                {          
                window.plugins.barcodeScanner.scan
                (
                    function(result) 
                    {	
                        if (!result.cancelled) 
                        {
                            $.ajax
                            ({
                                'async':false,
                                'type': "GET",
                                'url': "http://josephdstone-001-site1.smarterasp.net/api/Values?barcodes="+result.text,
                                'datatype':"json",
  				              'success': function(data) 
                                    {
                                        if (data != "")
                                        {
                                        grandTotal = document.getElementById('total').value;
                                        var val = data[0].price;
                                        counter += 1;
                                        $("#results").append("<li data-icon='minus' id="+counter+" onclick='deleteItem($(a"+counter+").text(), "+counter+");'><a style='color:white' id='a"+counter+"'>"+data[0].name +" $"+ data[0].price+"</a></li>");
                                        $('#results').listview('refresh');
                                        var split = $("#a1").text().split("$");
                                        totalScanned += parseFloat(data[0].price);
                                        taxRate = document.getElementById('tax').value * .01;
                                        grandTotal = totalScanned + (taxRate * totalScanned);
                                        document.getElementById('total').value =  (grandTotal).toFixed(2); 
                                        }
                                        else
                                        notification.alert();
                                     
                                    },
                                'error':function(data)
                                    {
                                        alert("Oops, sorry about that! Something happened, please try again!.");
                        
                                    }
                 })
                        }
                    })
            });
            
            
            
                   
        </script>
    
    </body>
</html>